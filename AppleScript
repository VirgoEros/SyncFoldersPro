
-- Sync Folders(helper.scpt) 

on run
	try
		tell application "Finder"
			set {button returned:SyncFolders} to Â¬
				display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡æ¬²é®¦æ­¥ä¹‹æ¨¡å¼å”·ğŸ’‹"} buttons Â¬
					{"é›™å‘A<+>Bé®¦æ­¥", "é±“å‘A+>Bé®¦æ­¥", "é±“å‘A->Bé®¦æ­¥"} with title Â¬
					{"å¯¦é°£é®¦æ­¥"}
			set sourcePath to (choose folder with prompt "è«‹æ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ A:ä¾†æºè³‡æ–™å¤¾ å”·ğŸ’‹" default location (path to (users folder)))
			set destinationPath to (choose folder with prompt "è«‹æ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ B:ç›®æ¨™è³‡æ–™å¤¾ å”·ğŸ’‹" default location (path to (startup disk)))
			
			if SyncFolders is "é›™å‘A<+>Bé®¦æ­¥" then my BidirectionalSyncAdditionsItem(sourcePath, destinationPath)
			if SyncFolders is "é±“å‘A+>Bé®¦æ­¥" then my SyncAdditionsItem(sourcePath, destinationPath)
			if SyncFolders is "é±“å‘A->Bé®¦æ­¥" then my SyncTrackingDeletionsItem(sourcePath, destinationPath)
		end tell
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end run

on addLoginItem(appName, pathOfApp)
	try
		tell application "System Events" to set allLoginItems to name of every login item as string
		if appName is in allLoginItems then
		else
			set appPath to POSIX path of pathOfApp
			tell application "System Events"
				make login item at end with properties {path:appPath, hidden:false}
			end tell
		end if
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end addLoginItem

on removeLoginItem(appName, pathOfApp)
	try
		tell application "System Events"
			if login item appName exists then delete login item appName
		end tell
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end removeLoginItem

on BidirectionalSyncAdditionsItem(sourcePath, destinationPath)
	try
		set APPitemPath to POSIX path of (path to me as text) Â¬
			& {"Contents/MacOS/rsync"}
		set APPitemPath to quoted form of APPitemPath
		do shell script ("if " & APPitemPath & " -aE --stats --exclude={.*,} " & quoted form of POSIX path of sourcePath & " " & quoted form of POSIX path of destinationPath & " " & quoted form of POSIX path of destinationPath & " " & quoted form of POSIX path of sourcePath & "; then echo 0; fi;")
		delay 1
		set isDone to false
		set itemPath to ("rsync ")
		set itemProgress to "ps ax | grep -v grep | grep " & itemPath
		repeat while isDone is false
			try
				do shell script itemProgress
				if the result contains itemPath then
					delay 1
				else
					set isDone to true
				end if
			on error
				set isDone to true
			end try
		end repeat
		if isDone is true then
			display notification (" 
åš«é±«çš„é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°~ 
é®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹") with title {"å¯¦é°£é®¦æ­¥"}
			do shell script ("open " & quoted form of POSIX path of destinationPath)
			continue quit
		end if
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end BidirectionalSyncAdditionsItem

on SyncAdditionsItem(sourcePath, destinationPath)
	try
		set APPitemPath to POSIX path of (path to me as text) Â¬
			& {"Contents/MacOS/rsync"}
		set APPitemPath to quoted form of APPitemPath
		do shell script ("if " & APPitemPath & " -aE --stats --exclude={.*,} " & quoted form of POSIX path of sourcePath & " " & quoted form of POSIX path of destinationPath & "; then echo 0; fi;")
		delay 1
		set isDone to false
		set itemPath to ("rsync ")
		set itemProgress to "ps ax | grep -v grep | grep " & itemPath
		repeat while isDone is false
			try
				do shell script itemProgress
				if the result contains itemPath then
					delay 1
				else
					set isDone to true
				end if
			on error
				set isDone to true
			end try
		end repeat
		if isDone is true then
			display notification (" 
åš«é±«çš„é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°~ 
é®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹") with title {"å¯¦é°£é®¦æ­¥"}
			do shell script ("open " & quoted form of POSIX path of destinationPath)
			continue quit
		end if
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end SyncAdditionsItem

on SyncTrackingDeletionsItem(sourcePath, destinationPath)
	try
		set APPitemPath to POSIX path of (path to me as text) Â¬
			& {"Contents/MacOS/rsync"}
		set APPitemPath to quoted form of APPitemPath
		do shell script ("if " & APPitemPath & " -aE --delete --stats --exclude={.*,} " & quoted form of POSIX path of sourcePath & " " & quoted form of POSIX path of destinationPath & "; then echo 0; fi;")
		delay 1
		set isDone to false
		set itemPath to ("rsync ")
		set itemProgress to "ps ax | grep -v grep | grep " & itemPath
		repeat while isDone is false
			try
				do shell script itemProgress
				if the result contains itemPath then
					delay 1
				else
					set isDone to true
				end if
			on error
				set isDone to true
			end try
		end repeat
		if isDone is true then
			display notification (" 
åš«é±«çš„é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°~ 
é®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹") with title {"å¯¦é°£é®¦æ­¥"}
			do shell script ("open " & quoted form of POSIX path of destinationPath)
			continue quit
		end if
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end SyncTrackingDeletionsItem

on copyItem(sourcePath, destinationPath, userName, userPass)
	try
		do shell script "if cp -Rp " & quoted form of sourcePath & " " & quoted form of destinationPath & "; then echo 0; fi;" user name userName password userPass with administrator privileges
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end copyItem

on moveItem(sourcePath, destinationPath, userName, userPass)
	try
		do shell script "if mv -f " & quoted form of sourcePath & " " & quoted form of destinationPath & "; then echo 0; fi;" user name userName password userPass with administrator privileges
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end moveItem

on removeItem(sourcePath, userName, userPass)
	try
		do shell script "if rm -rf " & quoted form of sourcePath & "; then echo 0; fi;" user name userName password userPass with administrator privileges
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end removeItem

on createDirectory(sourcePath, userName, userPass)
	try
		do shell script "if mkdir -p " & quoted form of sourcePath & "; then echo 0; fi;" user name userName password userPass with administrator privileges
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end createDirectory

on checkPass(userName, userPass)
	try
		do shell script "echo 0" user name userName password userPass with administrator privileges
	on error the error_message number the error_number
		if error_number = -128 then continue quit
		continue quit
	end try
end checkPass


-- 
